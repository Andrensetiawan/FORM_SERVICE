rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ======================
    // ROLE HELPERS
    // ======================
    function getRole() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
        : null;
    }

    function isAdmin()   { return getRole() == "admin"; }
    function isOwner()   { return getRole() == "owner"; }
    function isManager() { return getRole() == "manager"; }
    function isStaff()   { return getRole() == "staff"; }
    function isInternal() { return getRole() in ["admin", "owner", "manager", "staff"]; }

    // ======================
    // PUBLIC VIEWS (unguessable tokens)
    // ======================
    // Dokumen ini berisi mapping token -> docId dan subset yang boleh dibaca publik
    match /public_views/{token} {
      allow read: if true;
      // Mengizinkan create publik karena token tidak dapat ditebak.
      // Tambahkan validasi tambahan jika diperlukan.
      allow create: if true;
      allow update: if false;
      allow delete: if isAdmin();
    }

    // ======================
    // USERS
    // ======================
    match /users/{userId} {

      allow create: if request.auth != null;

      // User boleh baca profilnya sendiri
      allow get: if request.auth != null && request.auth.uid == userId;

      // Admin, Owner, Manager, & Staff boleh list semua user
      allow list, read: if isAdmin() || isOwner() || isManager() || isStaff();

      // User update profil sendiri
      allow update: if request.auth != null && request.auth.uid == userId;

      // Admin boleh update/delete siapa saja
      allow update, delete: if isAdmin();
    }

    // ======================
    // SERVICE REQUESTS
    // ======================
    match /service_requests/{docId} {

      // PUBLIC boleh baca SEMUA service request (atau sesuaikan jika mau dibatasi)
      allow read, list, get: if true;

      // PUBLIC boleh membuat service_request
      allow create: if true;

      // Internal boleh update
      allow update: if isInternal();

      // Delete hanya admin & owner
      allow delete: if isAdmin() || isOwner();

      // Subcollections
      match /payments/{paymentId} {
        // Pembayaran hanya boleh dibuat oleh user terautentikasi
        allow create: if request.auth != null
          && request.resource.data.amount is number
          && request.resource.data.amount > 0
          && (!request.resource.data.keys().hasAny(['proofUrls']) || (request.resource.data.proofUrls is list && request.resource.data.proofUrls.size() <= 6));
        allow read: if isInternal() || (request.auth != null && get(/databases/$(database)/documents/service_requests/$(docId)).data.created_by == request.auth.uid);
        allow update: if false;
        allow delete: if isAdmin();
      }

      match /customer_log/{logId} {
        // PUBLIC boleh baca
        allow read: if true;

        // PUBLIC boleh membuat customer_log entry, tapi batasi ukuran dan media count
        allow create: if request.resource.data.body is string
                      && request.resource.data.body.size() > 0
                      && request.resource.data.body.size() <= 2000
                      && (
                        !request.resource.data.keys().hasAny(['mediaUrls'])
                        || (request.resource.data.mediaUrls is list && request.resource.data.mediaUrls.size() <= 6)
                      );

        // Tidak mengizinkan update (immutable)
        allow update: if false;

        // Hanya admin/owner yang boleh menghapus
        allow delete: if isAdmin() || isOwner();
      }
    }

    // ======================
    // CABANGS
    // ======================
    match /cabangs/{docId} {
      allow read, list: if isInternal();
      allow create, update, delete: if isAdmin() || isOwner();
    }

    // ======================
    // LOGS
    // ======================
    match /logs/{logId} {
      allow create: if request.auth != null;

      allow read, list: if isInternal();

      allow delete: if isAdmin();
    }

    // ======================
    // REPORTS
    // ======================
    match /reports/{docId} {
      allow read, list, create, update, delete: if isAdmin();
    }

    // ======================
    // COUNTERS
    // ======================
    match /counters/{docId} {
      // Hanya user internal (staff, manager, etc.) yang bisa
      // membaca dan menaikkan (increment) nomor lacak.
      allow read, write: if isInternal();
    }

    // ======================
    // DEFAULT BLOCK
    // ======================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
